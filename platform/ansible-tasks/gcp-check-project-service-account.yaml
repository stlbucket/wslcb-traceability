- name: describe service account
  command: "gcloud iam service-accounts describe {{PROJECT_SERVICE_ACCOUNT_EMAIL}}"
  register: SA_DESCRIBE_RESULT
  ignore_errors: true
- set_fact:
    SA_DESCRIBE_ERROR: "{{(SA_DESCRIBE_RESULT.stderr_lines|length > 0)}}"
- fail:
    msg: "PLEASE ENSURE THAT THE PROJECT SERVICE ACCOUNT EXISTS WITH PROPER PERMISSIONS ++++> {{SA_DESCRIBE_RESULT}}"
  when: SA_DESCRIBE_ERROR == true
- name: check for sa key file
  stat: 
    path: "{{PROJECT_SERVICE_ACCOUNT_KEY_PATH}}"
  register: key_stat
- name: create key file for project service account
  command: >
    gcloud iam service-accounts keys create {{PROJECT_SERVICE_ACCOUNT_KEY_PATH}} --iam-account={{PROJECT_SERVICE_ACCOUNT_EMAIL}}
  when: key_stat.stat.exists == false
  